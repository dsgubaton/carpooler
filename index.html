<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carpool Splitter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3);
            background-size: 1800% 1800%;
            animation: rainbow 8s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        @keyframes rainbow {
            0% { background-position: 0% 82%; }
            50% { background-position: 100% 19%; }
            100% { background-position: 0% 82%; }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .section {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        h2 {
            color: #5047c7;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input, button {
            padding: 12px;
            border: 2px solid #5047c7;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        input {
            flex: 1;
            min-width: 150px;
        }

        button {
            background: #5047c7;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #6c50b8;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .cars-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .car-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .seat-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .seat-badge.warning {
            background: #f59e0b;
            color: #1a1a1a;
        }

        .seat-badge.full {
            background: #dc2f02;
            color: white;
        }

        .seat-meter {
            width: 100%;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }

        .seat-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #5047c7, #6c50b8);
            transition: width 0.3s ease;
        }

        .car-visual {
            font-size: 4em;
            text-align: center;
            margin: 10px 0;
            animation: wiggle 2s infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        .car-info {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .passengers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 40px;
        }

        .passenger-tag {
            background: #5047c7;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .passenger-tag:hover {
            background: #6c50b8;
            transform: scale(1.05);
        }

        .passenger-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }

        .unassigned-passengers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .unassigned-tag {
            background: #dc2f02;
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .unassigned-tag:hover {
            background: #c42503;
            transform: scale(1.05);
        }

        .unassigned-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }

        .seats-info {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .editable-seats {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .editable-seats:hover {
            color: #5047c7;
            font-weight: bold;
        }

        .event-input {
            width: 100%;
            font-size: 1.5em;
            text-align: center;
            padding: 15px;
            border: 3px solid #fff;
            border-radius: 15px;
            background: rgba(255,255,255,0.75);
            margin-bottom: 20px;
            font-weight: bold;
            color: #5047c7;
        }

        .event-input::placeholder {
            color: #aaa;
        }

        .save-btn {
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .save-btn:hover {
            background: #45a049;
            transform: scale(1.02);
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .clear-btn {
            background: rgba(220, 47, 2, 0.9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: rgba(238, 90, 82, 0.9);
            transform: scale(1.02);
        }

        .clear-btn:active {
            transform: scale(0.98);
        }

        .share-btn {
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .share-btn:hover {
            background: rgba(118, 75, 162, 0.9);
            transform: scale(1.02);
        }

        .share-btn:active {
            transform: scale(0.98);
        }

        .dancing-cookie {
            position: fixed;
            font-size: 4em;
            cursor: pointer;
            z-index: 1000;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: spin 2s linear infinite;
            transition: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
        }

        .delete-car {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc2f02;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }

            .input-group {
                flex-direction: column;
            }

            input, button {
                width: 100%;
            }
        }

        /* Game Boy BLOCKS Styles */
        .gameboy-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .gameboy-overlay.active {
            display: flex;
        }

        .gameboy {
            background: #9fa8a3;
            padding: 40px 30px;
            border-radius: 10px 10px 40px 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
        }

        .gameboy-screen {
            background: #9bbc0f;
            padding: 15px;
            border-radius: 5px;
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.3);
        }

        .blocks-canvas {
            display: block;
            background: #0f380f;
            border: 3px solid #306230;
            image-rendering: pixelated;
        }

        .gameboy-info {
            color: #0f380f;
            text-align: center;
            margin-top: 15px;
            font-family: monospace;
            font-weight: bold;
            font-size: 18px;
        }

        .gameboy-controls {
            margin-top: 20px;
            text-align: center;
            color: #0f380f;
            font-family: monospace;
            font-size: 14px;
        }

        .close-blocks {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #8b0000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

        /* BLOCKS letter reveal */
        .blocks-reveal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20vw;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.15);
            z-index: 9999;
            pointer-events: none;
            letter-spacing: 0.1em;
            font-family: 'Arial Black', sans-serif;
            text-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
        }

        /* Mobile Touch Controls */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            gap: 10px;
            flex-direction: column;
            align-items: center;
        }

        .mobile-controls.active {
            display: flex;
        }

        .control-row {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: rgba(155, 188, 15, 0.9);
            border: 3px solid #306230;
            border-radius: 10px;
            width: 60px;
            height: 60px;
            font-size: 24px;
            color: #0f380f;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .control-btn:active {
            background: #8bac0f;
            transform: scale(0.95);
        }

        .music-prompt {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(155, 188, 15, 0.95);
            padding: 15px 25px;
            border-radius: 15px;
            border: 3px solid #306230;
            color: #0f380f;
            font-weight: bold;
            z-index: 10002;
            display: none;
            animation: pulse 1s infinite;
        }

        .music-prompt.show {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        .cost-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .input-row label {
            font-weight: 600;
            color: #333;
            min-width: 140px;
        }

        .input-row input[type="number"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #5047c7;
            border-radius: 8px;
            font-size: 1em;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #5047c7, #6c50b8);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .calculate-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .cost-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #5047c7;
        }

        .cost-summary h3 {
            margin-bottom: 15px;
            color: #5047c7;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            font-size: 1.05em;
        }

        .cost-item strong {
            color: #333;
        }

        .cost-item .amount {
            color: #5047c7;
            font-weight: bold;
        }

        .payment-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .payment-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .payment-btn.venmo {
            background: #3D95CE;
            color: white;
        }

        .payment-btn.paypal {
            background: #0070BA;
            color: white;
        }

        .payment-btn.cashapp {
            background: #00A825;
            color: white;
        }

        .payment-btn:hover {
            transform: scale(1.05);
        }

        /* Undo Snackbar */
        .snackbar {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: #323232;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: bottom 0.3s ease;
            min-width: 300px;
            max-width: 90%;
        }

        .snackbar.show {
            bottom: 24px;
        }

        .snackbar-message {
            flex: 1;
            font-size: 0.95em;
        }

        .snackbar-action {
            background: #5047c7;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .snackbar-action:hover {
            background: #6c50b8;
        }

        /* Drag and Drop */
        .dragging {
            opacity: 0.5;
            cursor: grabbing !important;
        }

        .drag-over {
            background: rgba(80, 71, 199, 0.1);
            border: 3px dashed #5047c7;
        }

        .car-card.drag-over {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(80, 71, 199, 0.3);
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
            }

            .input-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .input-row label {
                min-width: auto;
            }

            .input-row input[type="number"] {
                width: 100%;
            }
        }

        /* Accessibility: Respect user's motion preferences */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            body {
                animation: none !important;
                background: #5047c7; /* Static gradient fallback */
            }

            .dancing-cookie {
                display: none !important; /* Hide dancing cookie */
            }

            .car-visual {
                animation: none !important;
            }

            .gameboy {
                animation: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Carpool Splitter üöô</h1>
        <p class="subtitle">Who's riding with who?! ü§™</p>

        <input type="text" id="eventName" class="event-input" placeholder="Event Name (e.g., Beach Trip!)">

        <button class="save-btn" onclick="saveData()">‚òÅÔ∏è Auto-Saving to Cloud!</button>

        <button class="share-btn" onclick="shareEvent()">üîó Share Event Link</button>

        <button class="clear-btn" onclick="clearEverything()">üßπ Clear Everything</button>

        <div class="section">
            <h2>Add Car üöó</h2>
            <div class="input-group">
                <input type="text" id="driverName" placeholder="Driver's name">
                <input type="number" id="seatCount" placeholder="# of seats" min="1" max="20">
                <button onclick="addCar()">Add Car</button>
            </div>
        </div>

        <div class="section">
            <h2>Add Friend üë´</h2>
            <div class="input-group">
                <input type="text" id="passengerName" placeholder="Friend's nickname">
                <button onclick="addPassenger()">Add Friend</button>
            </div>

            <h3 style="margin-top: 20px; color: #dc2f02;">Unassigned Friends:</h3>
            <div class="unassigned-passengers" id="unassignedList"></div>
        </div>

        <div class="section">
            <h2>Carpool Lineup ‚úÖ</h2>
            <div class="cars-container" id="carsContainer"></div>
        </div>

        <div class="section" id="costSection" style="display: none;">
            <h2>üí∏ Trip Cost Splitter</h2>
            <p style="margin-bottom: 15px; color: #666;">Calculate and split costs fairly among passengers</p>

            <div class="cost-inputs">
                <div class="input-row">
                    <label>Total Miles:</label>
                    <input type="number" id="totalMiles" placeholder="0" min="0" step="0.1">
                </div>
                <div class="input-row">
                    <label>Gas Price ($/gal):</label>
                    <input type="number" id="gasPrice" placeholder="3.50" min="0" step="0.01">
                </div>
                <div class="input-row">
                    <label>MPG:</label>
                    <input type="number" id="mpg" placeholder="25" min="1" step="0.1">
                </div>
                <div class="input-row">
                    <label>Tolls/Parking ($):</label>
                    <input type="number" id="tolls" placeholder="0" min="0" step="0.01">
                </div>
                <div class="input-row">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="driverPaysZero" checked>
                        Driver pays 0%
                    </label>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateCosts()">Calculate Split</button>

            <div id="costResults" style="display: none; margin-top: 20px;">
                <div class="cost-summary">
                    <h3>üí∞ Cost Breakdown</h3>
                    <div id="costBreakdown"></div>
                </div>

                <button class="share-btn" onclick="shareCosts()" style="margin-top: 15px;">üìã Share/Export Costs</button>

                <div id="paymentLinks" style="margin-top: 15px; display: none;">
                    <h4>Quick Payment Links:</h4>
                    <div class="payment-buttons" id="paymentButtons"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="dancing-cookie" aria-label="Bonus cookie" role="img">üç™</div>

    <!-- BLOCKS Letter Reveal -->
    <div class="blocks-reveal" id="blocksReveal"></div>

    <!-- Game Boy BLOCKS Easter Egg -->
    <div class="gameboy-overlay" id="blocksOverlay">
        <div class="gameboy">
            <button class="close-blocks" onclick="closeBlocks()">√ó</button>
            <div class="gameboy-screen">
                <canvas id="blocksCanvas" width="200" height="400" class="blocks-canvas"></canvas>
            </div>
            <div class="gameboy-info">
                <div>SCORE: <span id="blocksScore">0</span></div>
                <div>LEVEL: <span id="blocksLevel">1</span></div>
            </div>
            <div class="gameboy-controls">
                ‚Üê ‚Üí Move | ‚Üë Rotate | ‚Üì Drop<br>
                SPACE: Pause
            </div>
        </div>

        <!-- Mobile Touch Controls -->
        <div class="mobile-controls" id="mobileControls">
            <div class="control-row">
                <div class="control-btn" id="btnRotate">‚Üª</div>
            </div>
            <div class="control-row">
                <div class="control-btn" id="btnLeft">‚Üê</div>
                <div class="control-btn" id="btnDown">‚Üì</div>
                <div class="control-btn" id="btnRight">‚Üí</div>
            </div>
        </div>

        <!-- Music Prompt -->
        <div class="music-prompt" id="musicPrompt">üéµ Tap any button to start music!</div>
    </div>

    <!-- Firebase SDK -->
    <footer style="text-align: center; padding: 40px 20px; color: #fff; opacity: 0.8;">
        <p style="margin: 10px 0;">Made with ‚ù§Ô∏è for easy carpooling</p>
        <p style="margin: 10px 0;">
            <a href="privacy-policy.html" style="color: #fff; text-decoration: underline;">Privacy Policy</a>
        </p>
    </footer>

    <!-- Undo Snackbar -->
    <div class="snackbar" id="snackbar">
        <div class="snackbar-message" id="snackbarMessage"></div>
        <button class="snackbar-action" onclick="undoAction()">UNDO</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAvrgOMpVvBLdwBxB4jC2Wo0y5A770Sx40",
            authDomain: "carbooler.firebaseapp.com",
            databaseURL: "https://carbooler-default-rtdb.firebaseio.com/",
            projectId: "carbooler",
            storageBucket: "carbooler.firebasestorage.app",
            messagingSenderId: "77908116123",
            appId: "1:77908116123:web:9a95e4703ba68ace8d3c3e",
            measurementId: "G-Q18PEXLHS4"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Get or create event ID from URL parameter
        let eventId = null;
        let dbRef = null;

        function getOrCreateEventId() {
            const params = new URLSearchParams(window.location.search);
            const urlEventId = params.get('e');

            if (urlEventId) {
                // Joining existing event
                console.log('Joining event:', urlEventId);
                return urlEventId;
            } else {
                // Create new event
                const newEventId = self.crypto.randomUUID();
                console.log('Created new event:', newEventId);
                // Update URL without reload
                const newUrl = `${window.location.pathname}?e=${newEventId}`;
                window.history.pushState({}, '', newUrl);
                return newEventId;
            }
        }

        eventId = getOrCreateEventId();
        dbRef = database.ref(`events/${eventId}`);

        let cars = [];
        let unassignedPassengers = [];
        let selectedEmoji = 'üöô';
        let isSaving = false;

        // Security: Rate limiting to prevent spam
        let lastActionTime = 0;
        const ACTION_COOLDOWN = 500; // 500ms between actions

        // Debounce timer for event name input
        let eventNameDebounceTimer = null;

        // LocalStorage helper functions for name persistence
        function saveMyName(name) {
            try {
                localStorage.setItem('carpoolMyName', name);
            } catch(e) {
                console.log('Could not save name to localStorage:', e);
            }
        }

        function loadMyName() {
            try {
                return localStorage.getItem('carpoolMyName') || '';
            } catch(e) {
                console.log('Could not load name from localStorage:', e);
                return '';
            }
        }

        // Undo functionality
        let lastAction = null;
        let snackbarTimeout = null;

        function showSnackbar(message, actionData) {
            // Clear any existing timeout
            if (snackbarTimeout) {
                clearTimeout(snackbarTimeout);
            }

            // Store the action data for undo
            lastAction = actionData;

            // Show the snackbar
            const snackbar = document.getElementById('snackbar');
            const snackbarMessage = document.getElementById('snackbarMessage');
            snackbarMessage.textContent = message;
            snackbar.classList.add('show');

            // Auto-hide after 5 seconds
            snackbarTimeout = setTimeout(() => {
                hideSnackbar();
            }, 5000);
        }

        function hideSnackbar() {
            const snackbar = document.getElementById('snackbar');
            snackbar.classList.remove('show');
            if (snackbarTimeout) {
                clearTimeout(snackbarTimeout);
                snackbarTimeout = null;
            }
            // Clear the action after hiding
            setTimeout(() => {
                lastAction = null;
            }, 300);
        }

        function undoAction() {
            if (!lastAction) return;

            const action = lastAction;
            hideSnackbar();

            // Perform the undo based on action type
            if (action.type === 'assign') {
                // Undo assign: move passenger back to unassigned
                const car = cars.find(c => c.id === action.carId);
                if (car) {
                    const passengerIndex = car.passengers.findIndex(p => p.id === action.passengerId);
                    if (passengerIndex !== -1) {
                        const passenger = car.passengers[passengerIndex];
                        car.passengers.splice(passengerIndex, 1);
                        unassignedPassengers.push(passenger);
                        renderCars();
                        renderUnassigned();
                        autoSave();
                    }
                }
            } else if (action.type === 'unassign') {
                // Undo unassign: move passenger back to car
                const passenger = unassignedPassengers.find(p => p.id === action.passengerId);
                const car = cars.find(c => c.id === action.carId);
                if (passenger && car) {
                    const passengerIndex = unassignedPassengers.findIndex(p => p.id === action.passengerId);
                    unassignedPassengers.splice(passengerIndex, 1);
                    car.passengers.push(passenger);
                    renderCars();
                    renderUnassigned();
                    autoSave();
                }
            } else if (action.type === 'deletePassenger') {
                // Undo delete: add passenger back to unassigned
                unassignedPassengers.push({
                    id: action.passengerId,
                    name: action.passengerName
                });
                renderUnassigned();
                autoSave();
            } else if (action.type === 'deleteFromCar') {
                // Undo delete from car: add passenger back to the car
                const car = cars.find(c => c.id === action.carId);
                if (car) {
                    car.passengers.push({
                        id: action.passengerId,
                        name: action.passengerName
                    });
                    renderCars();
                    autoSave();
                }
            }

            lastAction = null;
        }

        // Drag and Drop handlers
        let draggedPassengerId = null;

        function handleDragStart(e) {
            const passengerId = parseInt(e.target.dataset.passengerId);
            draggedPassengerId = passengerId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            // Remove drag-over class from all car cards
            document.querySelectorAll('.car-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); // Necessary to allow drop
            }
            e.dataTransfer.dropEffect = 'move';

            // Add visual feedback
            const carCard = e.currentTarget;
            if (!carCard.classList.contains('drag-over')) {
                carCard.classList.add('drag-over');
            }

            return false;
        }

        function handleDragLeave(e) {
            // Only remove drag-over if we're leaving the car card entirely
            const carCard = e.currentTarget;
            if (!carCard.contains(e.relatedTarget)) {
                carCard.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation(); // Stop event bubbling
            }
            e.preventDefault();

            const carCard = e.currentTarget;
            carCard.classList.remove('drag-over');

            // Find the car ID from the onclick attribute
            const onclickAttr = carCard.getAttribute('onclick');
            const carIdMatch = onclickAttr.match(/handleCarClick\(event, (\d+)\)/);

            if (carIdMatch && draggedPassengerId) {
                const carId = parseInt(carIdMatch[1]);
                assignPassenger(draggedPassengerId, carId);
            }

            draggedPassengerId = null;
            return false;
        }

        function isRateLimited() {
            const now = Date.now();
            if (now - lastActionTime < ACTION_COOLDOWN) {
                alert('Slow down! You\'re going too fast üêå');
                return true;
            }
            lastActionTime = now;
            return false;
        }

        // Security: Sanitize user input to prevent XSS attacks
        function sanitizeInput(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Security: Validate input length and content
        function validateInput(input, maxLength, fieldName) {
            if (!input || input.trim().length === 0) {
                alert(`Please enter a ${fieldName}!`);
                return false;
            }
            if (input.length > maxLength) {
                alert(`${fieldName} must be ${maxLength} characters or less!`);
                return false;
            }
            // Block obviously malicious patterns
            if (/<script|javascript:|onerror|onclick/i.test(input)) {
                alert('Invalid characters detected!');
                return false;
            }
            return true;
        }

        // Auto-save function - now saves to Firebase!
        function autoSave() {
            if (isSaving) return; // Don't save if already saving

            isSaving = true;

            const eventName = document.getElementById('eventName').value.trim();

            // Security: Sanitize and limit event name length
            const sanitizedEventName = eventName.length > 100
                ? sanitizeInput(eventName.substring(0, 100))
                : sanitizeInput(eventName);

            // Use transactions to update specific fields atomically
            // This prevents overwriting teammates' concurrent edits
            const updates = {};
            updates[`events/${eventId}/eventName`] = sanitizedEventName;
            updates[`events/${eventId}/cars`] = cars;
            updates[`events/${eventId}/unassignedPassengers`] = unassignedPassengers;
            updates[`events/${eventId}/lastUpdated`] = firebase.database.ServerValue.TIMESTAMP;

            // Use update() instead of set() to avoid overwriting entire object
            database.ref().update(updates).then(() => {
                console.log('Saved to Firebase!');
                setTimeout(() => {
                    isSaving = false;
                }, 500);
            }).catch(error => {
                console.error('Error saving to Firebase:', error);
                isSaving = false;
            });
        }

        function addCar() {
            // Security: Rate limiting
            if (isRateLimited()) return;

            const driverName = document.getElementById('driverName').value.trim();
            const seatCount = parseInt(document.getElementById('seatCount').value);

            // Security: Validate driver name
            if (!validateInput(driverName, 50, 'driver name')) {
                return;
            }

            // Validate seat count
            if (!seatCount || seatCount < 1 || seatCount > 20) {
                alert('Please enter a valid seat count (1-20)!');
                return;
            }

            // Security: Sanitize driver name before storing
            const sanitizedName = sanitizeInput(driverName);

            // Save name to localStorage for persistence
            saveMyName(sanitizedName);

            cars.push({
                id: Date.now(),
                driver: sanitizedName,
                seats: seatCount,
                passengers: [],
                emoji: selectedEmoji
            });

            document.getElementById('driverName').value = '';
            document.getElementById('seatCount').value = '';

            renderCars();
            autoSave();
        }

        function addPassenger() {
            // Security: Rate limiting
            if (isRateLimited()) return;

            const passengerName = document.getElementById('passengerName').value.trim();

            // Security: Validate friend name
            if (!validateInput(passengerName, 50, 'friend name')) {
                return;
            }

            // Security: Sanitize friend name before storing
            const sanitizedName = sanitizeInput(passengerName);

            // Save name to localStorage for persistence
            saveMyName(sanitizedName);

            unassignedPassengers.push({
                id: Date.now(),
                name: sanitizedName
            });

            document.getElementById('passengerName').value = '';
            renderUnassigned();
            autoSave();
        }

        function assignPassenger(passengerId, carId) {
            const passenger = unassignedPassengers.find(p => p.id === passengerId);
            const car = cars.find(c => c.id === carId);

            if (!passenger || !car) return;

            if (car.passengers.length >= car.seats) {
                alert('This car is full!');
                return;
            }

            car.passengers.push(passenger);
            unassignedPassengers = unassignedPassengers.filter(p => p.id !== passengerId);

            renderCars();
            renderUnassigned();
            autoSave();

            // Show undo snackbar
            showSnackbar(`${passenger.name} assigned to ${car.driver}'s car`, {
                type: 'assign',
                passengerId: passenger.id,
                carId: car.id
            });
        }

        function removePassengerFromCar(carId, passengerId) {
            const car = cars.find(c => c.id === carId);
            const passenger = car.passengers.find(p => p.id === passengerId);

            if (!passenger) return;

            car.passengers = car.passengers.filter(p => p.id !== passengerId);
            unassignedPassengers.push(passenger);

            renderCars();
            renderUnassigned();
            autoSave();

            // Show undo snackbar
            showSnackbar(`${passenger.name} removed from ${car.driver}'s car`, {
                type: 'unassign',
                passengerId: passenger.id,
                carId: car.id
            });
        }

        function deleteCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (car) {
                unassignedPassengers.push(...car.passengers);
            }
            cars = cars.filter(c => c.id !== carId);
            renderCars();
            renderUnassigned();
            autoSave();
        }

        function editSeats(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;

            const newSeats = prompt(`Change number of seats for ${car.driver}'s car:`, car.seats);
            if (newSeats === null) return; // User cancelled

            const seatCount = parseInt(newSeats);
            if (isNaN(seatCount) || seatCount < 1) {
                alert('Please enter a valid number of seats!');
                return;
            }

            if (seatCount < car.passengers.length) {
                alert(`Cannot set seats to ${seatCount} because there are already ${car.passengers.length} friends in this car!`);
                return;
            }

            car.seats = seatCount;
            renderCars();
            autoSave();
        }

        function renderCars() {
            const container = document.getElementById('carsContainer');

            if (cars.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No cars yet! Add one above.</p>';
                return;
            }

            container.innerHTML = cars.map(car => {
                // Ensure passengers array exists
                if (!car.passengers) {
                    car.passengers = [];
                }
                const isFull = car.passengers.length >= car.seats;
                const seatsLeft = car.seats - car.passengers.length;
                const seatPercentage = (car.passengers.length / car.seats) * 100;
                return `
                    <div class="car-card ${isFull ? 'full' : ''}" onclick="handleCarClick(event, ${car.id})">
                        <button class="delete-car" onclick="event.stopPropagation(); deleteCar(${car.id})">√ó</button>
                        ${!isFull && seatsLeft <= 2 ? `<div class="seat-badge warning">${seatsLeft} seat${seatsLeft !== 1 ? 's' : ''} left</div>` : ''}
                        ${isFull ? '<div class="seat-badge full">FULL</div>' : ''}
                        <div class="car-visual">${car.emoji}</div>
                        <div class="car-info">
                            Driver: ${car.driver}
                        </div>
                        <div class="seats-info">
                            ${car.passengers.length} / <span class="editable-seats" onclick="event.stopPropagation(); editSeats(${car.id})">${car.seats}</span> seats filled
                        </div>
                        <div class="seat-meter">
                            <div class="seat-meter-fill" style="width: ${seatPercentage}%"></div>
                        </div>
                        <div class="passengers-list">
                            ${car.passengers.map(p => `
                                <div class="passenger-tag" onclick="event.stopPropagation(); removePassengerFromCar(${car.id}, ${p.id})">
                                    ${p.name}
                                    <span class="remove">√ó</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Add drag-and-drop event listeners to car cards
            container.querySelectorAll('.car-card').forEach(carCard => {
                carCard.addEventListener('dragover', handleDragOver);
                carCard.addEventListener('dragleave', handleDragLeave);
                carCard.addEventListener('drop', handleDrop);
            });
        }

        function removeUnassignedFriend(passengerId) {
            const passenger = unassignedPassengers.find(p => p.id === passengerId);
            if (!passenger) return;

            unassignedPassengers = unassignedPassengers.filter(p => p.id !== passengerId);
            renderUnassigned();
            autoSave();

            // Show undo snackbar
            showSnackbar(`${passenger.name} removed`, {
                type: 'deletePassenger',
                passengerId: passenger.id,
                passengerName: passenger.name
            });
        }

        function renderUnassigned() {
            const container = document.getElementById('unassignedList');

            if (unassignedPassengers.length === 0) {
                container.innerHTML = '<p style="color: #999;">All friends are assigned!</p>';
                return;
            }

            container.innerHTML = unassignedPassengers.map(p => `
                <div class="unassigned-tag" data-passenger-id="${p.id}" draggable="true">
                    ${p.name}
                    <span class="remove" onclick="event.stopPropagation(); removeUnassignedFriend(${p.id})">√ó</span>
                </div>
            `).join('');

            // Add click and drag handlers
            container.querySelectorAll('.unassigned-tag').forEach(tag => {
                // Click handler for mobile
                tag.addEventListener('click', function() {
                    const passengerId = parseInt(this.dataset.passengerId);
                    selectPassengerForAssignment(passengerId);
                });

                // Drag handlers for desktop
                tag.addEventListener('dragstart', handleDragStart);
                tag.addEventListener('dragend', handleDragEnd);
            });
        }

        let selectedPassengerId = null;

        function selectPassengerForAssignment(passengerId) {
            selectedPassengerId = passengerId;
            const passenger = unassignedPassengers.find(p => p.id === passengerId);
            alert(`Click on a car to assign ${passenger.name}! üöó`);
        }

        function handleCarClick(event, carId) {
            if (selectedPassengerId) {
                assignPassenger(selectedPassengerId, carId);
                selectedPassengerId = null;
            }
        }

        // Save and load functions - now using Firebase!
        function saveData() {
            const eventName = document.getElementById('eventName').value;
            const data = {
                eventName: eventName,
                cars: cars,
                unassignedPassengers: unassignedPassengers
            };
            dbRef.set(data).then(() => {
                alert('Progress saved to cloud! üíæ‚òÅÔ∏è');
            }).catch(error => {
                alert('Error saving: ' + error.message);
            });
        }

        // Clear everything function
        function shareEvent() {
            const shareUrl = window.location.href;

            // Try native share API first (mobile)
            if (navigator.share) {
                navigator.share({
                    title: 'Join my carpool event!',
                    text: 'Click this link to join and edit our carpool plan',
                    url: shareUrl
                }).then(() => {
                    console.log('Shared successfully');
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackCopyLink(shareUrl);
                });
            } else {
                // Fallback: copy to clipboard
                fallbackCopyLink(shareUrl);
            }
        }

        function fallbackCopyLink(url) {
            // Copy to clipboard
            navigator.clipboard.writeText(url).then(() => {
                alert('üîó Link copied to clipboard!\n\nShare this link with your group so they can join and edit together:\n\n' + url);
            }).catch(err => {
                // Ultra-fallback: show in alert
                alert('Share this link with your group:\n\n' + url);
            });
        }

        function clearEverything() {
            if (confirm('‚ö†Ô∏è This will clear ALL data for this event. Everyone will lose access. Are you sure?')) {
                // Clear local data
                cars = [];
                unassignedPassengers = [];
                document.getElementById('eventName').value = '';

                // Clear Firebase
                dbRef.remove().then(() => {
                    console.log('Firebase data cleared');
                }).catch(error => {
                    console.error('Error clearing Firebase:', error);
                });

                // Re-render
                renderCars();
                renderUnassigned();

                alert('Everything cleared! üßπ');
            }
        }

        // Show/hide cost section when cars exist
        function updateCostSectionVisibility() {
            const costSection = document.getElementById('costSection');
            if (cars.length > 0 && cars.some(car => car.passengers && car.passengers.length > 0)) {
                costSection.style.display = 'block';
            } else {
                costSection.style.display = 'none';
            }
        }

        // Calculate trip costs
        function calculateCosts() {
            const miles = parseFloat(document.getElementById('totalMiles').value) || 0;
            const gasPrice = parseFloat(document.getElementById('gasPrice').value) || 0;
            const mpg = parseFloat(document.getElementById('mpg').value) || 25;
            const tolls = parseFloat(document.getElementById('tolls').value) || 0;
            const driverPaysZero = document.getElementById('driverPaysZero').checked;

            if (miles === 0 || gasPrice === 0) {
                alert('Please enter total miles and gas price!');
                return;
            }

            // Calculate total gas cost
            const gasCost = (miles / mpg) * gasPrice;
            const totalCost = gasCost + tolls;

            // Build breakdown per car
            const breakdown = [];
            let totalPassengers = 0;

            cars.forEach(car => {
                if (!car.passengers || car.passengers.length === 0) return;

                const carPassengers = car.passengers.length;
                const totalInCar = driverPaysZero ? carPassengers : carPassengers + 1;
                const costPerPerson = totalCost / totalInCar;

                totalPassengers += carPassengers;

                breakdown.push({
                    driver: car.driver,
                    passengers: car.passengers,
                    costPerPerson: costPerPerson,
                    driverPays: driverPaysZero ? 0 : costPerPerson
                });
            });

            // Display results
            displayCostBreakdown(totalCost, gasCost, tolls, breakdown, driverPaysZero);
        }

        function displayCostBreakdown(total, gas, tolls, breakdown, driverPaysZero) {
            const resultsDiv = document.getElementById('costResults');
            const breakdownDiv = document.getElementById('costBreakdown');

            let html = `
                <div class="cost-item">
                    <strong>Total Trip Cost:</strong>
                    <span class="amount">$${total.toFixed(2)}</span>
                </div>
                <div class="cost-item" style="font-size: 0.9em; color: #666;">
                    <span>Gas: $${gas.toFixed(2)}</span>
                    <span>Tolls/Parking: $${tolls.toFixed(2)}</span>
                </div>
                <hr style="margin: 15px 0; border: none; border-top: 2px dashed #ddd;">
            `;

            breakdown.forEach(car => {
                html += `
                    <div class="cost-item" style="background: #e8f4f8;">
                        <strong>üöó ${car.driver}'s Car</strong>
                    </div>
                `;

                car.passengers.forEach(passenger => {
                    html += `
                        <div class="cost-item">
                            <span>${passenger.name}</span>
                            <span class="amount">$${car.costPerPerson.toFixed(2)}</span>
                        </div>
                    `;
                });

                if (car.driverPays > 0) {
                    html += `
                        <div class="cost-item">
                            <span>${car.driver} (Driver)</span>
                            <span class="amount">$${car.driverPays.toFixed(2)}</span>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="cost-item" style="font-size: 0.85em; color: #666;">
                            <span>${car.driver} (Driver)</span>
                            <span>$0.00 ‚ú®</span>
                        </div>
                    `;
                }
            });

            breakdownDiv.innerHTML = html;
            resultsDiv.style.display = 'block';

            // Show payment links for first driver (simplification)
            if (breakdown.length > 0) {
                displayPaymentLinks(breakdown[0]);
            }
        }

        function displayPaymentLinks(carBreakdown) {
            const linksDiv = document.getElementById('paymentLinks');
            const buttonsDiv = document.getElementById('paymentButtons');

            if (carBreakdown.passengers.length === 0) {
                linksDiv.style.display = 'none';
                return;
            }

            const amount = carBreakdown.costPerPerson.toFixed(2);
            const driverName = carBreakdown.driver;
            const note = encodeURIComponent(`Carpool - ${driverName}'s car`);

            buttonsDiv.innerHTML = `
                <a href="venmo://paycharge?recipients=${encodeURIComponent(driverName)}&amount=${amount}&note=${note}"
                   class="payment-btn venmo" target="_blank">
                    üíô Venmo
                </a>
                <a href="https://paypal.me/${encodeURIComponent(driverName)}/${amount}"
                   class="payment-btn paypal" target="_blank">
                    üí∞ PayPal
                </a>
                <a href="https://cash.app/$${encodeURIComponent(driverName)}/${amount}"
                   class="payment-btn cashapp" target="_blank">
                    üíµ Cash App
                </a>
            `;

            linksDiv.style.display = 'block';
        }

        function shareCosts() {
            const breakdownDiv = document.getElementById('costBreakdown');
            const text = breakdownDiv.innerText;

            // Try native share API
            if (navigator.share) {
                navigator.share({
                    title: 'Carpool Cost Split',
                    text: text
                }).catch(err => console.log('Share cancelled'));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(text).then(() => {
                    alert('üí∞ Cost breakdown copied to clipboard!');
                }).catch(err => {
                    alert('Cost breakdown:\n\n' + text);
                });
            }
        }

        function loadData() {
            // Real-time listener - updates whenever anyone makes a change!
            dbRef.on('value', (snapshot) => {
                // Don't update if we're currently saving
                if (isSaving) {
                    console.log('Skipping Firebase update - currently saving');
                    return;
                }

                const data = snapshot.val();

                // If no data exists yet (first time), just render empty state
                if (!data) {
                    console.log('No data in Firebase yet');
                    return;
                }

                console.log('Loading data from Firebase:', data);
                document.getElementById('eventName').value = data.eventName || '';
                cars = data.cars || [];
                unassignedPassengers = data.unassignedPassengers || [];

                // Ensure all cars have passengers arrays
                cars.forEach(car => {
                    if (!car.passengers) {
                        car.passengers = [];
                    }
                });

                renderCars();
                renderUnassigned();
            });
        }

        // Add auto-save to event name input with 300ms debounce
        document.getElementById('eventName').addEventListener('input', () => {
            clearTimeout(eventNameDebounceTimer);
            eventNameDebounceTimer = setTimeout(() => {
                autoSave();
            }, 300);
        });

        // Allow Enter key to submit
        document.getElementById('driverName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCar();
        });
        document.getElementById('seatCount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCar();
        });
        document.getElementById('passengerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addPassenger();
        });

        // Load saved data on page load
        loadData();

        // Pre-fill name inputs with saved name from localStorage
        const savedName = loadMyName();
        if (savedName) {
            document.getElementById('driverName').value = savedName;
            document.getElementById('passengerName').value = savedName;
        }

        // Initial render
        renderCars();
        renderUnassigned();

        // DVD-style bouncing cookie
        const cookie = document.querySelector('.dancing-cookie');
        let x = Math.random() * (window.innerWidth - 100);
        let y = Math.random() * (window.innerHeight - 100);
        let xSpeed = 2;
        let ySpeed = 2;

        // BLOCKS Easter Egg - Click cookie 6 times to spell BLOCKS
        let cookieClickCount = 0;
        const blocksLetters = ['B', 'L', 'O', 'C', 'K', 'S'];
        const blocksRevealDiv = document.getElementById('blocksReveal');
        let cookieResetTimer = null;

        cookie.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent event bubbling
            cookieClickCount++;

            // Initialize audio context on first click (iOS requirement)
            if (cookieClickCount === 1 && !audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('Audio context created on cookie click');
                } catch(e) {
                    console.log('Could not create audio context:', e);
                }
            }

            // Reset timer - if you don't complete within 5 seconds, reset
            clearTimeout(cookieResetTimer);
            cookieResetTimer = setTimeout(() => {
                cookieClickCount = 0;
                blocksRevealDiv.textContent = '';
            }, 5000);

            if (cookieClickCount <= 6) {
                // Build up BLOCKS letter by letter
                const currentWord = blocksLetters.slice(0, cookieClickCount).join('');
                blocksRevealDiv.textContent = currentWord;

                if (cookieClickCount === 6) {
                    // Spell complete! Launch BLOCKS
                    clearTimeout(cookieResetTimer);

                    // Start music immediately on 6th click (iOS needs direct user gesture)
                    if (audioContext) {
                        if (audioContext.state === 'suspended') {
                            audioContext.resume().then(() => {
                                playBlocksMusic();
                            });
                        } else {
                            playBlocksMusic();
                        }
                    }

                    setTimeout(() => {
                        blocksRevealDiv.textContent = '';
                        cookieClickCount = 0;
                        openBlocks();
                    }, 500);
                }
            }
        });

        function moveCookie() {
            x += xSpeed;
            y += ySpeed;

            const cookieSize = 64; // Approximate size of the emoji

            // Bounce off edges
            if (x + cookieSize >= window.innerWidth || x <= 0) {
                xSpeed = -xSpeed;
            }
            if (y + cookieSize >= window.innerHeight || y <= 0) {
                ySpeed = -ySpeed;
            }

            cookie.style.left = x + 'px';
            cookie.style.top = y + 'px';

            requestAnimationFrame(moveCookie);
        }

        moveCookie();

        // ============================================
        // BLOCKS EASTER EGG - GAME BOY STYLE
        // ============================================

        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 20;
        const COLORS = ['#0f380f', '#306230', '#0f380f', '#8bac0f', '#9bbc0f'];

        let blocksCanvas, blocksCtx;
        let blocksBoard = [];
        let currentPiece = null;
        let blocksScore = 0;
        let blocksLevel = 1;
        let blocksGameRunning = false;
        let blocksGameLoop = null;
        let blocksPaused = false;
        let blocksDropCounter = 0;
        let blocksDropInterval = 1000;

        // BLOCKS pieces (tetrominoes)
        const PIECES = {
            I: [[1,1,1,1]],
            O: [[1,1],[1,1]],
            T: [[0,1,0],[1,1,1]],
            S: [[0,1,1],[1,1,0]],
            Z: [[1,1,0],[0,1,1]],
            J: [[1,0,0],[1,1,1]],
            L: [[0,0,1],[1,1,1]]
        };

        function initBlocks() {
            blocksCanvas = document.getElementById('blocksCanvas');
            blocksCtx = blocksCanvas.getContext('2d');

            // Initialize board
            blocksBoard = Array(ROWS).fill().map(() => Array(COLS).fill(0));

            blocksScore = 0;
            blocksLevel = 1;
            updateBlocksUI();

            spawnPiece();

            // Music already started on cookie click - don't start again
        }

        function spawnPiece() {
            const pieces = Object.keys(PIECES);
            const randomPiece = pieces[Math.floor(Math.random() * pieces.length)];
            currentPiece = {
                shape: PIECES[randomPiece],
                x: Math.floor(COLS / 2) - 1,
                y: 0,
                color: 1
            };

            if (collision(currentPiece.x, currentPiece.y, currentPiece.shape)) {
                // Game over
                blocksGameRunning = false;
                alert('Game Over! Score: ' + blocksScore);
                closeBlocks();
            }
        }

        function collision(x, y, shape) {
            for (let row = 0; row < shape.length; row++) {
                for (let col = 0; col < shape[row].length; col++) {
                    if (shape[row][col] &&
                        (y + row >= ROWS ||
                         x + col < 0 ||
                         x + col >= COLS ||
                         blocksBoard[y + row] && blocksBoard[y + row][x + col])) {
                        return true;
                    }
                }
            }
            return false;
        }

        function merge() {
            currentPiece.shape.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value) {
                        blocksBoard[currentPiece.y + y][currentPiece.x + x] = currentPiece.color;
                    }
                });
            });
        }

        function rotate(shape) {
            const rotated = shape[0].map((_, i) =>
                shape.map(row => row[i]).reverse()
            );
            return rotated;
        }

        function clearLines() {
            let linesCleared = 0;
            for (let row = ROWS - 1; row >= 0; row--) {
                if (blocksBoard[row].every(cell => cell !== 0)) {
                    blocksBoard.splice(row, 1);
                    blocksBoard.unshift(Array(COLS).fill(0));
                    linesCleared++;
                    row++; // Check same row again
                }
            }
            if (linesCleared > 0) {
                blocksScore += linesCleared * 100 * blocksLevel;
                blocksLevel = Math.floor(blocksScore / 1000) + 1;
                blocksDropInterval = Math.max(100, 1000 - (blocksLevel * 100));
                updateBlocksUI();
            }
        }

        function movePiece(dir) {
            currentPiece.x += dir;
            if (collision(currentPiece.x, currentPiece.y, currentPiece.shape)) {
                currentPiece.x -= dir;
            }
        }

        function dropPiece() {
            currentPiece.y++;
            if (collision(currentPiece.x, currentPiece.y, currentPiece.shape)) {
                currentPiece.y--;
                merge();
                clearLines();
                spawnPiece();
            }
            blocksDropCounter = 0;
        }

        function hardDrop() {
            while (!collision(currentPiece.x, currentPiece.y + 1, currentPiece.shape)) {
                currentPiece.y++;
            }
            merge();
            clearLines();
            spawnPiece();
        }

        function rotatePiece() {
            const rotated = rotate(currentPiece.shape);
            if (!collision(currentPiece.x, currentPiece.y, rotated)) {
                currentPiece.shape = rotated;
            }
        }

        function drawBlocks() {
            // Clear canvas with Game Boy green
            blocksCtx.fillStyle = '#0f380f';
            blocksCtx.fillRect(0, 0, blocksCanvas.width, blocksCanvas.height);

            // Draw board
            blocksBoard.forEach((row, y) => {
                row.forEach((cell, x) => {
                    if (cell) {
                        drawBlock(x, y, '#8bac0f');
                    }
                });
            });

            // Draw current piece
            if (currentPiece) {
                currentPiece.shape.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value) {
                            drawBlock(currentPiece.x + x, currentPiece.y + y, '#9bbc0f');
                        }
                    });
                });
            }
        }

        function drawBlock(x, y, color) {
            blocksCtx.fillStyle = color;
            blocksCtx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
            blocksCtx.strokeStyle = '#306230';
            blocksCtx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
        }

        function updateBlocksUI() {
            document.getElementById('blocksScore').textContent = blocksScore;
            document.getElementById('blocksLevel').textContent = blocksLevel;
        }

        function blocksUpdate(deltaTime) {
            if (!blocksGameRunning || blocksPaused) return;

            blocksDropCounter += deltaTime;
            if (blocksDropCounter > blocksDropInterval) {
                dropPiece();
            }

            drawBlocks();
        }

        let lastBlocksTime = 0;
        function blocksLoop(time = 0) {
            const deltaTime = time - lastBlocksTime;
            lastBlocksTime = time;

            blocksUpdate(deltaTime);

            if (blocksGameRunning) {
                blocksGameLoop = requestAnimationFrame(blocksLoop);
            }
        }

        // BLOCKS controls
        document.addEventListener('keydown', (e) => {
            if (!blocksGameRunning) return;

            switch(e.key) {
                case 'ArrowLeft':
                    movePiece(-1);
                    break;
                case 'ArrowRight':
                    movePiece(1);
                    break;
                case 'ArrowDown':
                    dropPiece();
                    break;
                case 'ArrowUp':
                    rotatePiece();
                    break;
                case ' ':
                    blocksPaused = !blocksPaused;
                    break;
            }
        });

        function openBlocks() {
            document.getElementById('blocksOverlay').classList.add('active');
            document.getElementById('mobileControls').classList.add('active');
            blocksGameRunning = true;
            initBlocks();
            blocksLoop();

            // Music should already be playing from cookie click
            // But try to start if it somehow didn't
            if (!musicStarted && audioContext) {
                playBlocksMusic();
            }
        }

        function closeBlocks() {
            document.getElementById('blocksOverlay').classList.remove('active');
            document.getElementById('mobileControls').classList.remove('active');
            document.getElementById('musicPrompt').classList.remove('show');
            blocksGameRunning = false;
            musicStarted = false;
            if (blocksGameLoop) {
                cancelAnimationFrame(blocksGameLoop);
            }
            stopBlocksMusic();
        }

        // Mobile touch controls - also resume audio on first touch (iOS fix)
        function handleTouchControl(callback) {
            return function(e) {
                e.preventDefault();

                // Resume audio context on first touch (iOS requirement)
                if (audioContext && !musicStarted) {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().then(() => {
                            if (!isMusicPlaying) {
                                playBlocksMusic();
                                document.getElementById('musicPrompt').classList.remove('show');
                            }
                        });
                    } else if (!isMusicPlaying) {
                        playBlocksMusic();
                        document.getElementById('musicPrompt').classList.remove('show');
                    }
                }

                if (blocksGameRunning) callback();
            };
        }

        document.getElementById('btnLeft').addEventListener('touchstart', handleTouchControl(() => movePiece(-1)));
        document.getElementById('btnRight').addEventListener('touchstart', handleTouchControl(() => movePiece(1)));
        document.getElementById('btnDown').addEventListener('touchstart', handleTouchControl(() => dropPiece()));
        document.getElementById('btnRotate').addEventListener('touchstart', handleTouchControl(() => rotatePiece()));

        // BLOCKS Music using Web Audio API
        let audioContext;
        let musicGainNode;
        let isMusicPlaying = false;
        let musicStarted = false;

        function playBlocksMusic() {
            if (isMusicPlaying) return;

            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // iOS requires user interaction - resume if suspended
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        startMusic();
                    });
                } else {
                    startMusic();
                }
            } catch(e) {
                console.log('Audio not supported:', e);
            }
        }

        function startMusic() {
            if (isMusicPlaying) return;

            // Only create gain node if it doesn't exist
            if (!musicGainNode) {
                musicGainNode = audioContext.createGain();
                musicGainNode.gain.value = 0.08; // Lower volume for mobile
                musicGainNode.connect(audioContext.destination);
            }

            isMusicPlaying = true;
            musicStarted = true;

            // Hide the music prompt
            document.getElementById('musicPrompt').classList.remove('show');

            playBlocksTheme();
            console.log('BLOCKS music started!');
        }

        function stopBlocksMusic() {
            isMusicPlaying = false;
            if (audioContext && audioContext.state === 'running') {
                audioContext.suspend();
            }
        }

        // F√ºr Elise (Beethoven) - FROM SHEET MUSIC!
        function playBlocksTheme() {
            if (!isMusicPlaying) return;

            const notes = [
                // Measure 1-2: THE iconic opening! (A minor, Poco moto)
                {freq: 659.25, duration: 0.15}, // E5
                {freq: 622.25, duration: 0.15}, // D#5 (Eb)
                {freq: 659.25, duration: 0.15}, // E5
                {freq: 622.25, duration: 0.15}, // D#5 (Eb)
                {freq: 659.25, duration: 0.15}, // E5
                {freq: 493.88, duration: 0.15}, // B4
                {freq: 587.33, duration: 0.15}, // D5
                {freq: 523.25, duration: 0.15}, // C5
                {freq: 440.00, duration: 0.35}, // A4 (held)

                // Measure 3-4: Response phrase
                {freq: 0, duration: 0.15}, // Rest
                {freq: 261.63, duration: 0.1}, // C4 (bass note)
                {freq: 329.63, duration: 0.1}, // E4
                {freq: 440.00, duration: 0.1}, // A4
                {freq: 493.88, duration: 0.35}, // B4 (held)

                // Measure 5: Continuation
                {freq: 0, duration: 0.15}, // Rest
                {freq: 329.63, duration: 0.1}, // E4 (bass)
                {freq: 415.30, duration: 0.1}, // G#4
                {freq: 493.88, duration: 0.1}, // B4
                {freq: 523.25, duration: 0.35}, // C5 (held)

                // Measure 6-10 (Second ending): Repeat opening with variation
                {freq: 0, duration: 0.15}, // Rest
                {freq: 659.25, duration: 0.15}, // E5
                {freq: 622.25, duration: 0.15}, // D#5
                {freq: 659.25, duration: 0.15}, // E5
                {freq: 622.25, duration: 0.15}, // D#5
                {freq: 659.25, duration: 0.15}, // E5
                {freq: 493.88, duration: 0.15}, // B4
                {freq: 587.33, duration: 0.15}, // D5
                {freq: 523.25, duration: 0.15}, // C5
                {freq: 440.00, duration: 0.35}, // A4 (held)

                // Final resolution
                {freq: 0, duration: 0.15}, // Rest
                {freq: 261.63, duration: 0.1}, // C4
                {freq: 329.63, duration: 0.1}, // E4
                {freq: 440.00, duration: 0.1}, // A4
                {freq: 493.88, duration: 0.35}, // B4 (held)

                {freq: 0, duration: 0.15}, // Rest
                {freq: 329.63, duration: 0.1}, // E4
                {freq: 523.25, duration: 0.1}, // C5
                {freq: 493.88, duration: 0.1}, // B4
                {freq: 440.00, duration: 0.5}, // A4 (final, held longer)
                {freq: 0, duration: 0.3} // Rest before loop
            ];

            let time = audioContext.currentTime;
            notes.forEach(note => {
                const osc = audioContext.createOscillator();
                osc.connect(musicGainNode);
                osc.frequency.value = note.freq;
                osc.type = 'square'; // Game Boy sound
                osc.start(time);
                osc.stop(time + note.duration);
                time += note.duration;
            });

            // Loop the music
            setTimeout(() => {
                if (isMusicPlaying) playBlocksTheme();
            }, time * 1000 - audioContext.currentTime * 1000);
        }

        // Desktop shortcut: Press 'T' three times quickly
        let tPressCount = 0;
        let tPressTimer = null;
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                tPressCount++;
                clearTimeout(tPressTimer);

                if (tPressCount >= 3 && !blocksGameRunning) {
                    tPressCount = 0;
                    openBlocks();
                } else {
                    tPressTimer = setTimeout(() => {
                        tPressCount = 0;
                    }, 1000);
                }
            }
        });
    </script>
</body>
</html>
