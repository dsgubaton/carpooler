<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carpool Splitter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3);
            background-size: 1800% 1800%;
            animation: rainbow 8s ease infinite;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        @keyframes rainbow {
            0% { background-position: 0% 82%; }
            50% { background-position: 100% 19%; }
            100% { background-position: 0% 82%; }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        }

        .subtitle {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input, button {
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
        }

        input {
            flex: 1;
            min-width: 150px;
        }

        button {
            background: #667eea;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .cars-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .car-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .car-visual {
            font-size: 4em;
            text-align: center;
            margin: 10px 0;
            animation: wiggle 2s infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        .car-info {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .passengers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 40px;
        }

        .passenger-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .passenger-tag:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .passenger-tag .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
        }

        .unassigned-passengers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .unassigned-tag {
            background: #ff6b6b;
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .unassigned-tag:hover {
            background: #ee5a52;
            transform: scale(1.05);
        }

        .seats-info {
            text-align: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .editable-seats {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .editable-seats:hover {
            color: #667eea;
            font-weight: bold;
        }

        .event-input {
            width: 100%;
            font-size: 1.5em;
            text-align: center;
            padding: 15px;
            border: 3px solid #fff;
            border-radius: 15px;
            background: rgba(255,255,255,0.9);
            margin-bottom: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .event-input::placeholder {
            color: #aaa;
        }

        .save-btn {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .save-btn:hover {
            background: #45a049;
            transform: scale(1.02);
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .dancing-cookie {
            position: fixed;
            font-size: 4em;
            cursor: pointer;
            z-index: 1000;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: spin 2s linear infinite;
            transition: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
        }

        .delete-car {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }

            .input-group {
                flex-direction: column;
            }

            input, button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Carpool Splitter üöô</h1>
        <p class="subtitle">Who's riding with who?! ü§™</p>

        <input type="text" id="eventName" class="event-input" placeholder="Event Name (e.g., Beach Trip!)">

        <button class="save-btn" onclick="saveData()">‚òÅÔ∏è Auto-Saving to Cloud!</button>

        <div class="section">
            <h2>Add a Car üöó</h2>
            <div class="input-group">
                <input type="text" id="driverName" placeholder="Driver's name">
                <input type="number" id="seatCount" placeholder="# of seats" min="1" max="20">
                <button onclick="addCar()">Add Car</button>
            </div>
        </div>

        <div class="section">
            <h2>Add Friend üë´</h2>
            <div class="input-group">
                <input type="text" id="passengerName" placeholder="Friend's nickname">
                <button onclick="addPassenger()">Add Friend</button>
            </div>

            <h3 style="margin-top: 20px; color: #ff6b6b;">Unassigned Friends:</h3>
            <div class="unassigned-passengers" id="unassignedList"></div>
        </div>

        <div class="section">
            <h2>The Carpool Lineup ‚úÖ</h2>
            <div class="cars-container" id="carsContainer"></div>
        </div>
    </div>

    <div class="dancing-cookie">üç™</div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAvrgOMpVvBLdwBxB4jC2Wo0y5A770Sx40",
            authDomain: "carbooler.firebaseapp.com",
            databaseURL: "https://carbooler-default-rtdb.firebaseio.com/",
            projectId: "carbooler",
            storageBucket: "carbooler.firebasestorage.app",
            messagingSenderId: "77908116123",
            appId: "1:77908116123:web:9a95e4703ba68ace8d3c3e",
            measurementId: "G-Q18PEXLHS4"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const dbRef = database.ref('carpoolData');

        let cars = [];
        let unassignedPassengers = [];
        let selectedEmoji = 'üöô';
        let isLoadingFromFirebase = false;

        // Auto-save function - now saves to Firebase!
        function autoSave() {
            if (isLoadingFromFirebase) return; // Don't save while loading from Firebase

            const eventName = document.getElementById('eventName').value;
            const data = {
                eventName: eventName,
                cars: cars,
                unassignedPassengers: unassignedPassengers
            };

            // Save to Firebase instead of localStorage
            dbRef.set(data).catch(error => {
                console.error('Error saving to Firebase:', error);
            });
        }

        function addCar() {
            const driverName = document.getElementById('driverName').value.trim();
            const seatCount = parseInt(document.getElementById('seatCount').value);

            if (!driverName || !seatCount || seatCount < 1) {
                alert('Please enter a driver name and valid seat count!');
                return;
            }

            cars.push({
                id: Date.now(),
                driver: driverName,
                seats: seatCount,
                passengers: [],
                emoji: selectedEmoji
            });

            document.getElementById('driverName').value = '';
            document.getElementById('seatCount').value = '';

            renderCars();
            autoSave();
        }

        function addPassenger() {
            const passengerName = document.getElementById('passengerName').value.trim();

            if (!passengerName) {
                alert('Please enter a friend name!');
                return;
            }

            unassignedPassengers.push({
                id: Date.now(),
                name: passengerName
            });

            document.getElementById('passengerName').value = '';
            renderUnassigned();
            autoSave();
        }

        function assignPassenger(passengerId, carId) {
            const passenger = unassignedPassengers.find(p => p.id === passengerId);
            const car = cars.find(c => c.id === carId);

            if (!passenger || !car) return;

            if (car.passengers.length >= car.seats) {
                alert('This car is full!');
                return;
            }

            car.passengers.push(passenger);
            unassignedPassengers = unassignedPassengers.filter(p => p.id !== passengerId);

            renderCars();
            renderUnassigned();
            autoSave();
        }

        function removePassengerFromCar(carId, passengerId) {
            const car = cars.find(c => c.id === carId);
            const passenger = car.passengers.find(p => p.id === passengerId);

            if (!passenger) return;

            car.passengers = car.passengers.filter(p => p.id !== passengerId);
            unassignedPassengers.push(passenger);

            renderCars();
            renderUnassigned();
            autoSave();
        }

        function deleteCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (car) {
                unassignedPassengers.push(...car.passengers);
            }
            cars = cars.filter(c => c.id !== carId);
            renderCars();
            renderUnassigned();
            autoSave();
        }

        function editSeats(carId) {
            const car = cars.find(c => c.id === carId);
            if (!car) return;

            const newSeats = prompt(`Change number of seats for ${car.driver}'s car:`, car.seats);
            if (newSeats === null) return; // User cancelled

            const seatCount = parseInt(newSeats);
            if (isNaN(seatCount) || seatCount < 1) {
                alert('Please enter a valid number of seats!');
                return;
            }

            if (seatCount < car.passengers.length) {
                alert(`Cannot set seats to ${seatCount} because there are already ${car.passengers.length} friends in this car!`);
                return;
            }

            car.seats = seatCount;
            renderCars();
            autoSave();
        }

        function renderCars() {
            const container = document.getElementById('carsContainer');

            if (cars.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No cars yet! Add one above.</p>';
                return;
            }

            container.innerHTML = cars.map(car => {
                const isFull = car.passengers.length >= car.seats;
                return `
                    <div class="car-card ${isFull ? 'full' : ''}" onclick="handleCarClick(event, ${car.id})">
                        <button class="delete-car" onclick="event.stopPropagation(); deleteCar(${car.id})">√ó</button>
                        <div class="car-visual">${car.emoji}</div>
                        <div class="car-info">
                            Driver: ${car.driver}
                        </div>
                        <div class="seats-info">
                            ${car.passengers.length} / <span class="editable-seats" onclick="event.stopPropagation(); editSeats(${car.id})">${car.seats}</span> seats filled
                            ${isFull ? '(FULL!)' : ''}
                        </div>
                        <div class="passengers-list">
                            ${car.passengers.map(p => `
                                <div class="passenger-tag" onclick="event.stopPropagation(); removePassengerFromCar(${car.id}, ${p.id})">
                                    ${p.name}
                                    <span class="remove">√ó</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUnassigned() {
            const container = document.getElementById('unassignedList');

            if (unassignedPassengers.length === 0) {
                container.innerHTML = '<p style="color: #999;">All friends are assigned!</p>';
                return;
            }

            container.innerHTML = unassignedPassengers.map(p => `
                <div class="unassigned-tag" data-passenger-id="${p.id}">
                    ${p.name}
                </div>
            `).join('');

            // Add click handlers for drag-to-assign
            container.querySelectorAll('.unassigned-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const passengerId = parseInt(this.dataset.passengerId);
                    selectPassengerForAssignment(passengerId);
                });
            });
        }

        let selectedPassengerId = null;

        function selectPassengerForAssignment(passengerId) {
            selectedPassengerId = passengerId;
            const passenger = unassignedPassengers.find(p => p.id === passengerId);
            alert(`Click on a car to assign ${passenger.name}! üöó`);
        }

        function handleCarClick(event, carId) {
            if (selectedPassengerId) {
                assignPassenger(selectedPassengerId, carId);
                selectedPassengerId = null;
            }
        }

        // Save and load functions - now using Firebase!
        function saveData() {
            const eventName = document.getElementById('eventName').value;
            const data = {
                eventName: eventName,
                cars: cars,
                unassignedPassengers: unassignedPassengers
            };
            dbRef.set(data).then(() => {
                alert('Progress saved to cloud! üíæ‚òÅÔ∏è');
            }).catch(error => {
                alert('Error saving: ' + error.message);
            });
        }

        function loadData() {
            // Real-time listener - updates whenever anyone makes a change!
            dbRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    isLoadingFromFirebase = true;

                    document.getElementById('eventName').value = data.eventName || '';
                    cars = data.cars || [];
                    unassignedPassengers = data.unassignedPassengers || [];

                    renderCars();
                    renderUnassigned();

                    isLoadingFromFirebase = false;
                }
            });
        }

        // Add auto-save to event name input
        document.getElementById('eventName').addEventListener('input', autoSave);

        // Allow Enter key to submit
        document.getElementById('driverName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCar();
        });
        document.getElementById('seatCount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCar();
        });
        document.getElementById('passengerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addPassenger();
        });

        // Load saved data on page load
        loadData();

        // Initial render
        renderCars();
        renderUnassigned();

        // DVD-style bouncing cookie
        const cookie = document.querySelector('.dancing-cookie');
        let x = Math.random() * (window.innerWidth - 100);
        let y = Math.random() * (window.innerHeight - 100);
        let xSpeed = 2;
        let ySpeed = 2;

        function moveCookie() {
            x += xSpeed;
            y += ySpeed;

            const cookieSize = 64; // Approximate size of the emoji

            // Bounce off edges
            if (x + cookieSize >= window.innerWidth || x <= 0) {
                xSpeed = -xSpeed;
            }
            if (y + cookieSize >= window.innerHeight || y <= 0) {
                ySpeed = -ySpeed;
            }

            cookie.style.left = x + 'px';
            cookie.style.top = y + 'px';

            requestAnimationFrame(moveCookie);
        }

        moveCookie();
    </script>
</body>
</html>
